{% extends "base.html" %}
{% block content %}
<div id="page" class="max-w-4xl mx-auto">
  <div class="flex justify-between items-center mb-3">
     <a href="/" class="px-2 py-1 text-base bg-gray-200 dark:bg-gray-700 dark:text-gray-100 dark:hover:bg-gray-600 rounded-md hover:bg-gray-300">‚Üê Back</a>
    <h1 class="text-xl">Edit Blood Pressure Data</h1>
  </div>

  <div id="bp-chart" style="height: 520px;" class="mb-3"></div>

  <div class="text-sm text-center text-gray-600 dark:text-gray-400 mb-3">Editing last {{ entries|length }} of {{ total_count }} total records</div>

  {% if status_msg %}
  <div class="mb-3 p-2 border border-gray-300 dark:border-gray-600 rounded-md bg-yellow-50 dark:bg-yellow-900 dark:text-yellow-200 text-yellow-800">{{ status_msg }}</div>
  {% endif %}

  <form id="edit-form" action="/edit" method="post"
        hx-post="/edit" hx-target="#page" hx-swap="outerHTML" hx-disabled-elt="button">
    <div class="overflow-x-auto">
      <table class="border-collapse border border-gray-300 dark:border-gray-600 mx-auto mt-3 rounded-none overflow-hidden shadow-lg">
        <thead>
          <tr>
            <th class="border border-gray-300 dark:border-gray-600 px-2 py-1 text-center text-r bg-gray-300 dark:bg-gray-700 font-semibold text-gray-800 dark:text-gray-200">Timestamp (ISO+Offset)</th>
            <th class="border border-gray-300 dark:border-gray-600 px-2 py-1 text-r bg-gray-300 dark:bg-gray-700 font-semibold text-gray-800 dark:text-gray-200">Timezone</th>
            <th class="border border-gray-300 dark:border-gray-600 px-2 py-1 text-r bg-gray-300 dark:bg-gray-700 font-semibold text-gray-800 dark:text-gray-200">Systolic</th>
            <th class="border border-gray-300 dark:border-gray-600 px-2 py-1 text-r bg-gray-300 dark:bg-gray-700 font-semibold text-gray-800 dark:text-gray-200">Diastolic</th>
            <th class="border border-gray-300 dark:border-gray-600 px-2 py-1 text-r bg-gray-300 dark:bg-gray-700 font-semibold text-gray-800 dark:text-gray-200">Pulse</th>
            <th class="border border-gray-300 dark:border-gray-600 px-2 py-1 text-r bg-gray-300 dark:bg-gray-700 font-semibold text-gray-800 dark:text-gray-200">Raw Input</th>
          </tr>
        </thead>
        <tbody>
          {% for entry in entries %}
          <tr class="font-mono even:bg-blue-50 dark:even:bg-gray-800 hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors duration-200">
            <td class="border border-gray-300 dark:border-gray-600 px-2">
              <input name="t" type="text" class="px-1 py-1 text-center text-r bg-transparent dark:bg-gray-700 dark:text-gray-100 rounded" value="{{ entry.t }}" placeholder="YYYY-MM-DDTHH:MM:SS+HH:MM" required />
            </td>
            <td class="border border-gray-300 dark:border-gray-600 px-2">
              <input name="local_tz" type="text" class="w-full px-1 py-1 text-center text-r bg-transparent dark:bg-gray-700 dark:text-gray-100 rounded" value="{{ entry.local_tz or 'Asia/Shanghai' }}" required />
            </td>
            <td class="border border-gray-300 dark:border-gray-600 px-2">
              <input name="sys" type="number" min="70" max="250" class="w-full px-1 py-1 text-center text-r bg-transparent dark:bg-gray-700 dark:text-gray-100 rounded" value="{{ entry.sys }}" required />
            </td>
            <td class="border border-gray-300 dark:border-gray-600 px-2">
              <input name="dia" type="number" min="40" max="150" class="w-full px-1 py-1 text-center text-r bg-transparent dark:bg-gray-700 dark:text-gray-100 rounded" value="{{ entry.dia }}" required />
            </td>
            <td class="border border-gray-300 dark:border-gray-600 px-2">
              <input name="pulse" type="number" min="30" max="220" class="w-full px-1 py-1 text-center text-r bg-transparent dark:bg-gray-700 dark:text-gray-100 rounded" value="{{ entry.pulse }}" required />
            </td>
            <td class="border border-gray-300 dark:border-gray-600 px-2">
              <input name="raw" type="text" class="w-full px-1 py-1 text-r bg-transparent dark:bg-gray-700 dark:text-gray-100 rounded" value="{{ entry.raw or '' }}" required />
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>

    <div class="mt-4 flex gap-2 justify-center">
      <button type="button" onclick="addRow()" class="px-4 py-2 bg-gray-400 dark:bg-gray-600 text-white rounded-md hover:bg-green-600 dark:hover:bg-green-700">Add Entry</button>
      <button type="submit" class="px-4 py-2 bg-blue-500 text-white rounded-md hover:bg-blue-600">Save Changes</button>
    </div>
  </form>
</div>

<script>
function addRow() {
  const tbody = document.querySelector('tbody');
  const newRow = document.createElement('tr');
  newRow.className = 'even:bg-blue-50 dark:even:bg-gray-800 hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors duration-200';
  newRow.innerHTML = `
    <td class="border border-gray-300 dark:border-gray-600 px-2">
      <input name="t" type="text" class="w-full px-1 py-1 text-sm border border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-gray-100 rounded" placeholder="YYYY-MM-DDTHH:MM:SS+HH:MM" required />
    </td>
    <td class="border border-gray-300 dark:border-gray-600 px-2">
      <input name="local_tz" type="text" class="w-full px-1 py-1 text-sm border border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-gray-100 rounded" value="Asia/Shanghai" required />
    </td>
    <td class="border border-gray-300 dark:border-gray-600 px-2">
      <input name="sys" type="number" min="70" max="250" class="w-full px-1 py-1 text-sm border border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-gray-100 rounded" required />
    </td>
    <td class="border border-gray-300 dark:border-gray-600 px-2">
      <input name="dia" type="number" min="40" max="150" class="w-full px-1 py-1 text-sm border border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-gray-100 rounded" required />
    </td>
    <td class="border border-gray-300 dark:border-gray-600 px-2">
      <input name="pulse" type="number" min="30" max="220" class="w-full px-1 py-1 text-sm border border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-gray-100 rounded" required />
    </td>
    <td class="border border-gray-300 dark:border-gray-600 px-2">
      <input name="raw" type="text" class="w-full px-1 py-1 text-sm border border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-gray-100 rounded" required />
    </td>
  `;
  tbody.appendChild(newRow);
}

// Initialize chart on page load
renderBPChart('bp-chart', { showPulse: true, meOnly: false, nightShadows: false, initialZoomDays: 30 });

// Re-initialize chart after HTMX swap (form save)
document.addEventListener('htmx:afterSwap', function(event) {
  if (event.detail.target.id === 'page') {
    const chartElement = document.getElementById('bp-chart');
    if (chartElement) {
      const existingChart = echarts.getInstanceByDom(chartElement);
      if (existingChart) {
        existingChart.dispose();
      }
      renderBPChart('bp-chart', { showPulse: true, meOnly: false, nightShadows: false, initialZoomDays: 30 });
    }
  }
});
</script>
{% endblock %}