{% extends "base.html" %}
{% block content %}
<div id="page" class="max-w-4xl mx-auto">
  <!-- New compact header -->
  <div class="compact-header mb-4">
    <!-- Row 1: Settings + Title (mobile only) -->
    <div class="header-row-1 flex items-center gap-2 mb-2">
      <!-- Settings icon buttons -->
      <button type="button" id="btn-filter" class="icon-btn" title="Filter: Morning/Evening only">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
          <polygon points="22 3 2 3 10 12.46 10 19 14 21 14 12.46 22 3"/>
        </svg>
      </button>
      <button type="button" id="btn-night" class="icon-btn" title="Night shadows">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
          <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/>
        </svg>
      </button>
      <button type="button" id="btn-pulse" class="icon-btn" title="Show pulse on chart">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
          <path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"/>
        </svg>
      </button>

      <!-- App title (mobile only) -->
      <h1 class="app-title-mobile">Blood Pressure and Pulse</h1>
    </div>

    <!-- Row 2: Timezone + Input + Save -->
    <div class="header-row-2 flex items-center gap-2">
      <!-- Entry form -->
      <form id="entry-form" class="flex items-center gap-2 flex-1 min-w-[200px]"
            action="/add" method="post"
            hx-post="/add" hx-target="#page" hx-swap="outerHTML" hx-disabled-elt="button">
        <!-- Timezone pill (clickable) -->
        <button type="button" id="tz-pill" class="tz-badge {{ timezone_info.badge_class }}">
          {{ timezone_info.city }}
        </button>
        <input type="hidden" name="local_tz" id="local_tz_input" />
        <input name="line" type="text" class="input-compact"
               placeholder="e.g.: 120 80 56"
               inputmode="numeric"
               value="{{ input_value or '' }}" />
        <button type="submit" class="btn-save">Save</button>
      </form>
    </div>
  </div>

  <!-- Timezone selector modal (hidden by default) -->
  <div id="tz-modal" class="modal hidden">
    <div class="modal-content">
      <div class="modal-header flex justify-between items-center mb-4">
        <h3 class="text-lg font-semibold">Select Timezone</h3>
        <button type="button" id="tz-modal-close" class="text-2xl leading-none">&times;</button>
      </div>
      <div class="modal-body" id="tz-modal-body">
        <!-- Timezone options populated by JS -->
      </div>
    </div>
  </div>
  
  <!--div class="min-h-[1.2em] text-gray-600 mb-1.5">{{ status_msg or "" }}</div-->
   <div class="text-sm text-gray-600 dark:text-gray-400 mb-3">Records: {{ entries_count }}</div>
  

  

    <div id="bp-chart" style="height:520px;"></div>
  <script>

    (function() {
      // Read persisted settings and call renderBPChart with matching options
      let showPulse = true;
      let meOnly = false;
      let nightShadows = false;
       let localTz = localStorage.getItem('local_tz') || '{{ current_timezone }}';
      try {
        const sp = localStorage.getItem('showPulse');
        showPulse = sp === null ? true : JSON.parse(sp);
      } catch (e) {}
      try {
        const fm = localStorage.getItem('filter_me_only');
        meOnly = fm === null ? false : JSON.parse(fm);
      } catch (e) {}
      try {
        const ns = localStorage.getItem('night_shadows');
        nightShadows = ns === null ? false : JSON.parse(ns);
      } catch (e) {}

       // Set localStorage to server timezone to inherit it
       localStorage.setItem('local_tz', localTz);

       // Set hidden input to current timezone
       const localTzInput = document.getElementById('local_tz_input');
       if (localTzInput) localTzInput.value = localTz;

      renderBPChart('bp-chart', { showPulse: Boolean(showPulse), meOnly: Boolean(meOnly), nightShadows: Boolean(nightShadows) })
        .catch(err => {});
    })();
  </script>



  <!-- Server-generated chart removed in favor of client-side `renderBPChart()` -->
  
  <div>
    <div class="flex items-center justify-center mt-3">
       <div class="text-lg text-gray-600 dark:text-gray-400 font-semibold mb-2"><span class="font-mono text-gray-900 dark:text-gray-100">Daily measurements </span><a href="/edit" class="mx-0 px-4 py-2 font-bold text-sm bg-gray-200 dark:bg-gray-700 dark:text-gray-100 dark:hover:bg-blue-600 rounded-md hover:bg-blue-500 hover:text-white">Edit</a></div>
    </div>
    <div class="overflow-x-auto">
      <table class="w-auto border-collapse border border-gray-300 dark:border-gray-600 mx-auto mt-1 rounded-none overflow-hidden shadow-lg">
      <thead class="font-mono">
        <tr>
          <th rowspan="2" class="py-1 border-gray-300 dark:border-gray-600 text-center text-sm bg-gray-300 dark:bg-gray-700 font-semibold text-gray-800 dark:text-gray-200 sm:px-2.5">Date</th>
          <th colspan="2" class="py-1 border-gray-300 dark:border-gray-600 text-center text-sm bg-gray-300 dark:bg-gray-700 font-semibold text-gray-800 dark:text-gray-200 sm:px-2.5">Morning</th>
          <th colspan="2" class="py-1 border-gray-300 dark:border-gray-600 text-center text-sm bg-gray-300 dark:bg-gray-700 font-semibold text-gray-800 dark:text-gray-200 sm:px-2.5">Evening</th>
        </tr>
        <tr>
          <th class="border-gray-300 dark:border-gray-600 text-center text-sm bg-gray-300 dark:bg-gray-700 text-gray-800 dark:text-gray-200">Pressure</th>
          <th class="border-gray-300 dark:border-gray-600 text-center text-sm bg-gray-300 dark:bg-gray-700 text-gray-800 dark:text-gray-200 pulse-column">Pulse</th>
          <th class="border-gray-300 dark:border-gray-600 text-center text-sm bg-gray-300 dark:bg-gray-700 text-gray-800 dark:text-gray-200">Pressure</th>
          <th class="border-gray-300 dark:border-gray-600 text-center text-sm bg-gray-300 dark:bg-gray-700 text-gray-800 dark:text-gray-200 pulse-column">Pulse</th>
        </tr>
      </thead>
      <tbody>
        {% for day in grouped_data %}
        <tr class="font-mono even:bg-blue-50 dark:even:bg-gray-800 hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors duration-200">
          <td class="border border-gray-300 dark:border-gray-600 px-6 text-center text-sm text-gray-900 dark:text-gray-100">{{ day.date }}</td>
          <td class="border border-gray-300 dark:border-gray-600 px-6 text-center text-sm whitespace-pre text-gray-900 dark:text-gray-100">{% if day.morning %}{{ "%3d"|format(day.morning.sys) }} <span class="text-gray-400 dark:text-gray-500">/</span> {{ "%3d"|format(day.morning.dia) }}{% endif %}</td>
          <td class="border border-gray-300 dark:border-gray-600 px-6 text-center text-sm whitespace-pre pulse-column text-gray-900 dark:text-gray-100">{% if day.morning %}{{ day.morning.pulse }}{% endif %}</td>
          <td class="border border-gray-300 dark:border-gray-600 px-6 text-center text-sm whitespace-pre text-gray-900 dark:text-gray-100">{% if day.evening %}{{ "%3d"|format(day.evening.sys) }} <span class="text-gray-400 dark:text-gray-500">/</span> {{ "%3d"|format(day.evening.dia) }}{% endif %}</td>
          <td class="border border-gray-300 dark:border-gray-600 px-6 text-center text-sm whitespace-pre pulse-column text-gray-900 dark:text-gray-100">{% if day.evening %}{{ day.evening.pulse }}{% endif %}</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
    </div>
  </div>
</div>
<script>
  // Timezone badge update functions
  function updateTimezoneBadge(tzName) {
    const badge = document.getElementById('tz-pill');
    if (!badge) return;
    
    // Load timezone mapping from config via API
    fetch('/api/timezones')
      .then(response => response.json())
      .then(config => {
        const tzMapping = config.timezones || {};
        const tzInfo = tzMapping[tzName] || tzMapping['Asia/Shanghai'] || {
          city: 'Shanghai',
          badgeClass: 'tz-badge--shanghai'
        };
        
        // Remove existing badge classes
        badge.className = 'tz-badge';
        // Add new badge class
        badge.classList.add(tzInfo.badgeClass);
        // Update badge text
        badge.textContent = tzInfo.city;
      })
      .catch(() => {
        // Fallback to hardcoded defaults
        const tzMapping = {
          'Asia/Shanghai': {
            city: 'Shanghai',
            badgeClass: 'tz-badge--shanghai'
          },
          'Europe/Moscow': {
            city: 'Moscow',
            badgeClass: 'tz-badge--moscow'
          }
        };
        const tzInfo = tzMapping[tzName] || tzMapping['Asia/Shanghai'];
        
        // Remove existing badge classes
        badge.className = 'tz-badge';
        // Add new badge class
        badge.classList.add(tzInfo.badgeClass);
        // Update badge text
        badge.textContent = tzInfo.city;
      });
  }

  // Populate timezone modal
  function populateTimezoneModal() {
    const modalBody = document.getElementById('tz-modal-body');
    if (!modalBody) return;
    
    fetch('/api/timezones')
      .then(response => response.json())
      .then(config => {
        const tzMapping = config.timezones || {};
        const currentTz = localStorage.getItem('local_tz') || '{{ current_timezone }}';
        
        // Clear existing content
        modalBody.innerHTML = '';
        
        // Add timezone buttons
        for (const [tzName, tzInfo] of Object.entries(tzMapping)) {
          const btn = document.createElement('button');
          btn.type = 'button';
          btn.className = 'tz-option w-full text-left px-4 py-3 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-md mb-2 transition-colors';
          btn.innerHTML = `<div class="font-semibold">${tzInfo.city}</div><div class="text-sm text-gray-500">${tzInfo.utc_offset}</div>`;
          
          if (tzName === currentTz) {
            btn.classList.add('bg-blue-50', 'dark:bg-blue-900', 'border', 'border-blue-300', 'dark:border-blue-700');
          }
          
          btn.addEventListener('click', () => {
            selectTimezone(tzName);
          });
          
          modalBody.appendChild(btn);
        }
      })
      .catch(() => {
        // Fallback to hardcoded defaults
        const timezones = [
          { name: 'Asia/Shanghai', city: 'Shanghai', offset: 'UTC+8' },
          { name: 'Europe/Moscow', city: 'Moscow', offset: 'UTC+3' },
          { name: 'America/New_York', city: 'New York', offset: 'UTC-5' }
        ];
        const currentTz = localStorage.getItem('local_tz') || '{{ current_timezone }}';
        
        modalBody.innerHTML = '';
        
        timezones.forEach(tz => {
          const btn = document.createElement('button');
          btn.type = 'button';
          btn.className = 'tz-option w-full text-left px-4 py-3 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-md mb-2 transition-colors';
          btn.innerHTML = `<div class="font-semibold">${tz.city}</div><div class="text-sm text-gray-500">${tz.offset}</div>`;
          
          if (tz.name === currentTz) {
            btn.classList.add('bg-blue-50', 'dark:bg-blue-900', 'border', 'border-blue-300', 'dark:border-blue-700');
          }
          
          btn.addEventListener('click', () => {
            selectTimezone(tz.name);
          });
          
          modalBody.appendChild(btn);
        });
      });
  }

  // Select timezone and update UI
  function selectTimezone(tzName) {
    localStorage.setItem('local_tz', tzName);
    
    // Update hidden input for form submission
    const localTzInput = document.getElementById('local_tz_input');
    if (localTzInput) localTzInput.value = tzName;
    
    // Update badge
    updateTimezoneBadge(tzName);
    
    // Close modal
    const modal = document.getElementById('tz-modal');
    if (modal) modal.classList.add('hidden');
    
    // Re-populate modal to update selection
    populateTimezoneModal();
  }

  // Update icon button states
  function updateIconButtons() {
    const filter = JSON.parse(localStorage.getItem('filter_me_only') || 'false');
    const night = JSON.parse(localStorage.getItem('night_shadows') || 'false');
    const pulse = JSON.parse(localStorage.getItem('showPulse') || 'true');

    document.getElementById('btn-filter').classList.toggle('active', filter);
    document.getElementById('btn-night').classList.toggle('active', night);
    document.getElementById('btn-pulse').classList.toggle('active', pulse);
  }

  // Toggle pulse columns visibility
  function togglePulseColumns(show) {
    const elements = document.querySelectorAll('.pulse-column');
    elements.forEach(el => el.style.display = show ? 'table-cell' : 'none');

    // Adjust colspan of super-headers
    const headers = document.querySelectorAll('th[colspan]');
    headers.forEach(header => {
      header.setAttribute('colspan', show ? '2' : '1');
    });
  }

  // Initialize on page load
  (function() {
    // Initialize icon button states
    updateIconButtons();
    
    // Initialize timezone
    let localTz = localStorage.getItem('local_tz') || '{{ current_timezone }}';
    localStorage.setItem('local_tz', localTz);
    
    // Set hidden input to current timezone
    const localTzInput = document.getElementById('local_tz_input');
    if (localTzInput) localTzInput.value = localTz;
    
    // Update timezone badge
    updateTimezoneBadge(localTz);
    
    // Populate timezone modal
    populateTimezoneModal();
    
    // Initialize pulse columns visibility
    const showPulse = JSON.parse(localStorage.getItem('showPulse') || 'true');
    togglePulseColumns(showPulse);
    
    // Render chart with current settings
    const meOnly = JSON.parse(localStorage.getItem('filter_me_only') || 'false');
    const nightShadows = JSON.parse(localStorage.getItem('night_shadows') || 'false');
    renderBPChart('bp-chart', { showPulse: Boolean(showPulse), meOnly: Boolean(meOnly), nightShadows: Boolean(nightShadows) })
      .catch(err => {});
  })();

  // Icon button event listeners
  document.getElementById('btn-filter').addEventListener('click', () => {
    const current = JSON.parse(localStorage.getItem('filter_me_only') || 'false');
    localStorage.setItem('filter_me_only', JSON.stringify(!current));
    updateIconButtons();
    
    // Re-render chart
    const showPulse = JSON.parse(localStorage.getItem('showPulse') || 'true');
    const meOnly = !current;
    const nightShadows = JSON.parse(localStorage.getItem('night_shadows') || 'false');
    renderBPChart('bp-chart', { showPulse: Boolean(showPulse), meOnly: Boolean(meOnly), nightShadows: Boolean(nightShadows) })
      .catch(err => {});
  });

  document.getElementById('btn-night').addEventListener('click', () => {
    const current = JSON.parse(localStorage.getItem('night_shadows') || 'false');
    localStorage.setItem('night_shadows', JSON.stringify(!current));
    updateIconButtons();
    
    // Re-render chart
    const showPulse = JSON.parse(localStorage.getItem('showPulse') || 'true');
    const meOnly = JSON.parse(localStorage.getItem('filter_me_only') || 'false');
    const nightShadows = !current;
    renderBPChart('bp-chart', { showPulse: Boolean(showPulse), meOnly: Boolean(meOnly), nightShadows: Boolean(nightShadows) })
      .catch(err => {});
  });

  document.getElementById('btn-pulse').addEventListener('click', () => {
    const current = JSON.parse(localStorage.getItem('showPulse') || 'true');
    localStorage.setItem('showPulse', JSON.stringify(!current));
    updateIconButtons();
    
    // Toggle pulse columns
    togglePulseColumns(!current);
    
    // Re-render chart
    const showPulse = !current;
    const meOnly = JSON.parse(localStorage.getItem('filter_me_only') || 'false');
    const nightShadows = JSON.parse(localStorage.getItem('night_shadows') || 'false');
    renderBPChart('bp-chart', { showPulse: Boolean(showPulse), meOnly: Boolean(meOnly), nightShadows: Boolean(nightShadows) })
      .catch(err => {});
  });

  // Timezone modal event listeners
  const tzModal = document.getElementById('tz-modal');
  const tzPill = document.getElementById('tz-pill');

  tzPill.addEventListener('click', () => {
    tzModal.classList.remove('hidden');
    populateTimezoneModal();
  });

  document.getElementById('tz-modal-close').addEventListener('click', () => {
    tzModal.classList.add('hidden');
  });

  // Close on backdrop click
  tzModal.addEventListener('click', (e) => {
    if (e.target === tzModal) {
      tzModal.classList.add('hidden');
    }
  });

  // Close on Escape key
  document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape' && !tzModal.classList.contains('hidden')) {
      tzModal.classList.add('hidden');
    }
  });

  // Re-render chart after HTMX swaps
  document.body.addEventListener('htmx:afterSwap', function(evt) {
    try {
      const target = evt.detail && evt.detail.target;
      if (target && target.id === 'page') {
        // Re-initialize icon buttons
        updateIconButtons();
        
        // Re-initialize timezone
        const localTz = localStorage.getItem('local_tz') || '{{ current_timezone }}';
        updateTimezoneBadge(localTz);
        
        // Re-render chart
        const showPulse = JSON.parse(localStorage.getItem('showPulse') || 'true');
        const meOnly = JSON.parse(localStorage.getItem('filter_me_only') || 'false');
        const nightShadows = JSON.parse(localStorage.getItem('night_shadows') || 'false');
        
        // Update pulse columns
        togglePulseColumns(showPulse);
        
        renderBPChart('bp-chart', { showPulse: Boolean(showPulse), meOnly: Boolean(meOnly), nightShadows: Boolean(nightShadows) })
          .catch(err => {});
      }
    } catch (e) {
      console.error('Error in htmx:afterSwap:', e);
    }
  });

</script>
{% endblock %}

